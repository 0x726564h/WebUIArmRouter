{% extends "base.html" %}

{% block title %}ArmRouter - Топология сети{% endblock %}
{% block page_title %}Топология сети{% endblock %}

{% block additional_styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/topology-visualizer.css') }}">
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Топология сети</h1>
    <div class="page-actions">
        <button class="btn btn-light" id="scanNetworkBtn">
            <span data-icon="search"></span>
            Сканировать сеть
        </button>
        <button class="btn btn-primary" id="saveTopologyBtn">
            <span data-icon="save"></span>
            Сохранить
        </button>
    </div>
</div>

<div class="page-content">
    <div class="card">
        <div class="card-header">
            <h2>Визуализация сети</h2>
            <div class="card-actions">
                <button class="btn btn-icon" id="resetZoomBtn" title="Сбросить масштаб">
                    <span data-icon="maximize"></span>
                </button>
                <button class="btn btn-icon" id="zoomInBtn" title="Увеличить">
                    <span data-icon="zoom-in"></span>
                </button>
                <button class="btn btn-icon" id="zoomOutBtn" title="Уменьшить">
                    <span data-icon="zoom-out"></span>
                </button>
                <button class="card-toggle">
                    <span data-icon="chevron-up"></span>
                </button>
            </div>
        </div>
        <div class="card-content">
            <div class="topology-container">
                <div class="network-visualizer" id="networkVisualizer">
                    <!-- Визуализатор будет добавлен через JavaScript -->
                    <div class="loader-container" id="topologyLoader">
                        <div class="loader"></div>
                        <div class="loader-text">Загрузка данных топологии...</div>
                    </div>
                    <div class="error-container" id="topologyError" style="display: none;">
                        <div class="error-icon">
                            <span data-icon="alert-triangle"></span>
                        </div>
                        <h3>Ошибка загрузки данных</h3>
                        <p class="error-message">Не удалось загрузить данные топологии сети. Попробуйте обновить страницу или выполнить сканирование сети.</p>
                        <button class="btn btn-primary" id="retryLoadBtn">
                            <span data-icon="refresh-cw"></span>
                            Повторить
                        </button>
                    </div>
                </div>
                
                <div class="device-details-card card" id="deviceDetails" style="display: none;">
                    <div class="card-header">
                        <h2>Информация об устройстве</h2>
                        <div class="card-actions">
                            <button class="btn btn-icon" id="closeDeviceDetails">
                                <span data-icon="x"></span>
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="device-header">
                            <div class="device-icon" data-type="">
                                <span data-icon="device"></span>
                            </div>
                            <div class="device-title">
                                <h3 id="deviceName">Устройство</h3>
                                <div class="device-status status-online" id="deviceStatus">Онлайн</div>
                            </div>
                        </div>
                        
                        <div class="device-info">
                            <div class="info-item">
                                <div class="label">IP адрес</div>
                                <div class="value" id="deviceIp">--</div>
                            </div>
                            <div class="info-item">
                                <div class="label">MAC адрес</div>
                                <div class="value" id="deviceMac">--</div>
                            </div>
                            <div class="info-item">
                                <div class="label">Тип</div>
                                <div class="value" id="deviceType">--</div>
                            </div>
                            <div class="info-item">
                                <div class="label">Производитель</div>
                                <div class="value" id="deviceVendor">--</div>
                            </div>
                        </div>
                        
                        <div class="device-section" id="interfacesSection">
                            <h4>Интерфейсы</h4>
                            <div class="table-responsive">
                                <table class="table" id="interfacesTable">
                                    <thead>
                                        <tr>
                                            <th>Название</th>
                                            <th>IP адрес</th>
                                            <th>MAC адрес</th>
                                            <th>Статус</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="4" class="text-center">Загрузка данных...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="device-section" id="servicesSection">
                            <h4>Сервисы</h4>
                            <div class="table-responsive">
                                <table class="table" id="servicesTable">
                                    <thead>
                                        <tr>
                                            <th>Порт</th>
                                            <th>Протокол</th>
                                            <th>Сервис</th>
                                            <th>Статус</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="4" class="text-center">Загрузка данных...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="device-actions">
                            <button class="btn btn-primary" id="pingDeviceBtn">
                                <span data-icon="activity"></span>
                                Пинг
                            </button>
                            <button class="btn btn-light" id="scanDeviceBtn">
                                <span data-icon="search"></span>
                                Сканировать
                            </button>
                            <button class="btn btn-danger" id="removeDeviceBtn">
                                <span data-icon="trash-2"></span>
                                Удалить
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2>Обнаруженные устройства</h2>
            <div class="card-actions">
                <button class="card-toggle">
                    <span data-icon="chevron-up"></span>
                </button>
            </div>
        </div>
        <div class="card-content">
            <div class="table-responsive">
                <table class="table" id="devicesTable">
                    <thead>
                        <tr>
                            <th>Название</th>
                            <th>IP адрес</th>
                            <th>MAC адрес</th>
                            <th>Тип</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" class="text-center">Загрузка данных...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно сканирования сети -->
<div class="modal" id="scanNetworkModal">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Сканирование сети</h3>
                <button class="modal-close" id="closeScanModal">
                    <span data-icon="x"></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="scanRange">Диапазон IP адресов:</label>
                    <input type="text" class="form-control" id="scanRange" placeholder="192.168.1.0/24">
                    <div class="form-hint">Укажите диапазон IP адресов в формате CIDR (например, 192.168.1.0/24)</div>
                </div>
                
                <div class="form-group">
                    <label>Параметры сканирования:</label>
                    <div class="checkbox-group">
                        <label class="checkbox">
                            <input type="checkbox" id="scanPorts" checked>
                            <span class="checkbox-custom"></span>
                            <span class="checkbox-label">Сканировать порты</span>
                        </label>
                        <label class="checkbox">
                            <input type="checkbox" id="scanVendors" checked>
                            <span class="checkbox-custom"></span>
                            <span class="checkbox-label">Определять производителя</span>
                        </label>
                        <label class="checkbox">
                            <input type="checkbox" id="scanServices">
                            <span class="checkbox-custom"></span>
                            <span class="checkbox-label">Определять сервисы</span>
                        </label>
                    </div>
                </div>
                
                <div id="scanProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-bar-value" style="width: 0%"></div>
                    </div>
                    <p class="progress-text">Сканирование: 0%</p>
                    
                    <div class="scan-results" style="display: none;">
                        <h4>Обнаружено устройств: <span id="scanFoundCount">0</span></h4>
                        <div class="scan-devices-list" id="scanDevicesList">
                            <!-- Список устройств будет добавлен через JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light" id="cancelScanBtn">Отмена</button>
                <button class="btn btn-primary" id="startScanBtn">Начать сканирование</button>
                <button class="btn btn-primary" id="addDevicesBtn" style="display: none;">Добавить выбранные устройства</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- D3.js для визуализации -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<!-- Компонент визуализатора топологии -->
<script src="{{ url_for('static', filename='js/components/topology-visualizer.js') }}"></script>

<!-- Основной скрипт для страницы топологии -->
<script src="{{ url_for('static', filename='js/topology.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация визуализатора топологии
    const visualizerContainer = document.getElementById('networkVisualizer');
    const loader = document.getElementById('topologyLoader');
    const errorContainer = document.getElementById('topologyError');
    
    // Инициализация кнопок масштабирования
    const zoomInBtn = document.getElementById('zoomInBtn');
    const zoomOutBtn = document.getElementById('zoomOutBtn');
    const resetZoomBtn = document.getElementById('resetZoomBtn');
    
    // Инициализация панели деталей устройства
    const deviceDetails = document.getElementById('deviceDetails');
    const closeDeviceDetails = document.getElementById('closeDeviceDetails');
    
    // Инициализация кнопок действий с устройствами
    const pingDeviceBtn = document.getElementById('pingDeviceBtn');
    const scanDeviceBtn = document.getElementById('scanDeviceBtn');
    const removeDeviceBtn = document.getElementById('removeDeviceBtn');
    
    // Инициализация модального окна сканирования
    const scanNetworkBtn = document.getElementById('scanNetworkBtn');
    const scanNetworkModal = document.getElementById('scanNetworkModal');
    const closeScanModal = document.getElementById('closeScanModal');
    const cancelScanBtn = document.getElementById('cancelScanBtn');
    const startScanBtn = document.getElementById('startScanBtn');
    
    // Инициализация полей ввода для сканирования
    const scanRange = document.getElementById('scanRange');
    const scanPorts = document.getElementById('scanPorts');
    const scanVendors = document.getElementById('scanVendors');
    const scanServices = document.getElementById('scanServices');
    
    // Инициализация прогресса сканирования
    const scanProgress = document.getElementById('scanProgress');
    const progressBar = document.querySelector('.progress-bar-value');
    const progressText = document.querySelector('.progress-text');
    
    // Инициализация результатов сканирования
    const scanResults = document.querySelector('.scan-results');
    const scanFoundCount = document.getElementById('scanFoundCount');
    const scanDevicesList = document.getElementById('scanDevicesList');
    const addDevicesBtn = document.getElementById('addDevicesBtn');
    
    // Кнопка сохранения топологии
    const saveTopologyBtn = document.getElementById('saveTopologyBtn');
    
    // Таблица устройств
    const devicesTable = document.getElementById('devicesTable');
    
    // Переменные для хранения данных
    let topologyData = null;
    let visualizer = null;
    let selectedDevice = null;
    let scanJobId = null;
    
    // Загрузка данных топологии
    loadTopologyData();
    
    /**
     * Загружает данные топологии
     */
    function loadTopologyData() {
        // Показываем индикатор загрузки
        loader.style.display = 'flex';
        errorContainer.style.display = 'none';
        
        // Выполняем запрос к API
        fetch('/api/topology/network')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка загрузки данных топологии');
                }
                return response.json();
            })
            .then(data => {
                console.log('Данные топологии:', data);
                topologyData = data;
                
                // Скрываем индикатор загрузки
                loader.style.display = 'none';
                
                // Инициализируем визуализатор или обновляем данные
                if (!visualizer) {
                    initializeVisualizer(data);
                } else {
                    visualizer.setData(data.nodes, data.links);
                }
                
                // Обновляем таблицу устройств
                updateDevicesTable(data.nodes);
            })
            .catch(error => {
                console.error('Ошибка загрузки данных топологии:', error);
                
                // Скрываем индикатор загрузки и показываем ошибку
                loader.style.display = 'none';
                errorContainer.style.display = 'flex';
            });
    }
    
    /**
     * Инициализирует визуализатор топологии
     */
    function initializeVisualizer(data) {
        console.log('Инициализация визуализатора с данными:', data);
        
        // Создаем экземпляр визуализатора
        visualizer = new TopologyVisualizer(visualizerContainer, {
            nodeRadius: 25,
            linkDistance: 150,
            theme: document.body.classList.contains('dark-theme') ? 'dark' : 'light'
        });
        
        // Устанавливаем данные
        visualizer.setData(data.nodes, data.links);
        
        // Добавляем обработчики событий
        visualizerContainer.addEventListener('node:select', handleNodeSelect);
        visualizerContainer.addEventListener('node:deselect', handleNodeDeselect);
        
        // Обработчики для кнопок масштабирования
        zoomInBtn.addEventListener('click', () => visualizer.zoom(1.2));
        zoomOutBtn.addEventListener('click', () => visualizer.zoom(0.8));
        resetZoomBtn.addEventListener('click', () => visualizer.resetZoom());
    }
    
    /**
     * Обрабатывает выбор узла в визуализаторе
     */
    function handleNodeSelect(event) {
        const node = event.detail.node;
        console.log('Выбран узел:', node);
        
        // Сохраняем выбранное устройство
        selectedDevice = node;
        
        // Обновляем информацию в панели деталей
        updateDeviceDetails(node);
        
        // Показываем панель деталей
        deviceDetails.style.display = 'block';
    }
    
    /**
     * Обрабатывает отмену выбора узла
     */
    function handleNodeDeselect(event) {
        console.log('Отменен выбор узла:', event.detail.node);
        
        // Скрываем панель деталей
        deviceDetails.style.display = 'none';
        
        // Сбрасываем выбранное устройство
        selectedDevice = null;
    }
    
    /**
     * Обновляет информацию в панели деталей устройства
     */
    function updateDeviceDetails(device) {
        // Обновляем заголовок и статус
        document.getElementById('deviceName').textContent = device.name || 'Устройство';
        
        const statusElement = document.getElementById('deviceStatus');
        statusElement.textContent = device.status === 'online' ? 'Онлайн' : 'Офлайн';
        statusElement.className = `device-status status-${device.status || 'offline'}`;
        
        // Обновляем иконку
        const iconElement = document.querySelector('.device-icon');
        iconElement.setAttribute('data-type', device.type || 'device');
        iconElement.querySelector('[data-icon]').setAttribute('data-icon', getDeviceIcon(device.type));
        
        // Обновляем основную информацию
        document.getElementById('deviceIp').textContent = device.ip || 'Нет данных';
        document.getElementById('deviceMac').textContent = device.mac || 'Нет данных';
        document.getElementById('deviceType').textContent = getDeviceTypeName(device.type) || 'Неизвестно';
        document.getElementById('deviceVendor').textContent = device.vendor || 'Нет данных';
        
        // Обновляем таблицу интерфейсов
        if (device.interfaces && device.interfaces.length > 0) {
            document.getElementById('interfacesSection').style.display = 'block';
            
            const interfacesTableBody = document.getElementById('interfacesTable').querySelector('tbody');
            let interfacesHtml = '';
            
            device.interfaces.forEach(iface => {
                interfacesHtml += `
                    <tr>
                        <td>${iface.name}</td>
                        <td>${iface.ip || 'Нет данных'}</td>
                        <td>${iface.mac || 'Нет данных'}</td>
                        <td><span class="status-${iface.status || 'down'}">${iface.status === 'up' ? 'Активен' : 'Отключен'}</span></td>
                    </tr>
                `;
            });
            
            interfacesTableBody.innerHTML = interfacesHtml;
        } else {
            document.getElementById('interfacesSection').style.display = 'none';
        }
        
        // Обновляем таблицу сервисов
        if (device.services && device.services.length > 0) {
            document.getElementById('servicesSection').style.display = 'block';
            
            const servicesTableBody = document.getElementById('servicesTable').querySelector('tbody');
            let servicesHtml = '';
            
            device.services.forEach(service => {
                servicesHtml += `
                    <tr>
                        <td>${service.port}</td>
                        <td>${service.protocol}</td>
                        <td>${service.name || 'Неизвестно'}</td>
                        <td><span class="status-${service.status || 'down'}">${service.status === 'up' ? 'Активен' : 'Отключен'}</span></td>
                    </tr>
                `;
            });
            
            servicesTableBody.innerHTML = servicesHtml;
        } else {
            document.getElementById('servicesSection').style.display = 'none';
        }
    }
    
    /**
     * Возвращает название типа устройства
     */
    function getDeviceTypeName(type) {
        const types = {
            'router': 'Маршрутизатор',
            'switch': 'Коммутатор',
            'access_point': 'Точка доступа',
            'server': 'Сервер',
            'device': 'Устройство',
            'internet': 'Интернет'
        };
        
        return types[type] || 'Устройство';
    }
    
    /**
     * Возвращает иконку для типа устройства
     */
    function getDeviceIcon(type) {
        const icons = {
            'router': 'router',
            'switch': 'switch',
            'access_point': 'wifi',
            'server': 'server',
            'device': 'device',
            'internet': 'globe'
        };
        
        return icons[type] || 'device';
    }
    
    /**
     * Обновляет таблицу устройств
     */
    function updateDevicesTable(devices) {
        const tableBody = devicesTable.querySelector('tbody');
        let html = '';
        
        if (devices && devices.length > 0) {
            devices.forEach(device => {
                html += `
                    <tr>
                        <td>${device.name || 'Устройство'}</td>
                        <td>${device.ip || 'Нет данных'}</td>
                        <td>${device.mac || 'Нет данных'}</td>
                        <td>${getDeviceTypeName(device.type)}</td>
                        <td><span class="status-${device.status || 'offline'}">${device.status === 'online' ? 'Онлайн' : 'Офлайн'}</span></td>
                        <td>
                            <button class="btn btn-icon btn-sm" data-action="details" data-id="${device.id}" title="Подробности">
                                <span data-icon="info"></span>
                            </button>
                            <button class="btn btn-icon btn-sm" data-action="ping" data-id="${device.id}" title="Пинг">
                                <span data-icon="activity"></span>
                            </button>
                            <button class="btn btn-icon btn-sm btn-danger" data-action="remove" data-id="${device.id}" title="Удалить">
                                <span data-icon="trash-2"></span>
                            </button>
                        </td>
                    </tr>
                `;
            });
        } else {
            html = '<tr><td colspan="6" class="text-center">Нет данных</td></tr>';
        }
        
        tableBody.innerHTML = html;
        
        // Инициализируем иконки в таблице
        if (window.IconsLoader) {
            window.IconsLoader.init(tableBody);
        }
        
        // Добавляем обработчики для кнопок действий
        tableBody.querySelectorAll('[data-action]').forEach(button => {
            button.addEventListener('click', handleDeviceAction);
        });
    }
    
    /**
     * Обрабатывает действия с устройствами в таблице
     */
    function handleDeviceAction(event) {
        const button = event.currentTarget;
        const action = button.getAttribute('data-action');
        const deviceId = button.getAttribute('data-id');
        
        console.log(`Действие ${action} для устройства ${deviceId}`);
        
        // Находим устройство по ID
        const device = topologyData.nodes.find(node => node.id === deviceId);
        
        if (!device) {
            console.error(`Устройство с ID ${deviceId} не найдено`);
            return;
        }
        
        // Выполняем действие
        switch (action) {
            case 'details':
                // Выбираем устройство в визуализаторе
                visualizer.selectNode(device);
                break;
                
            case 'ping':
                pingDevice(device);
                break;
                
            case 'remove':
                removeDevice(device);
                break;
        }
    }
    
    /**
     * Пингует устройство
     */
    function pingDevice(device) {
        showNotification(`Пинг устройства ${device.name || device.ip}...`, 'info');
        
        fetch(`/api/topology/device/${device.id}/ping`)
            .then(response => response.json())
            .then(data => {
                console.log('Результат пинга:', data);
                
                if (data.success) {
                    showNotification(`Устройство ${device.name || device.ip} доступно: ${data.response_time}ms`, 'success');
                } else {
                    showNotification(`Устройство ${device.name || device.ip} недоступно`, 'error');
                }
            })
            .catch(error => {
                console.error('Ошибка при выполнении пинга:', error);
                showNotification(`Ошибка при выполнении пинга: ${error.message}`, 'error');
            });
    }
    
    /**
     * Удаляет устройство из топологии
     */
    function removeDevice(device) {
        if (!confirm(`Вы уверены, что хотите удалить устройство ${device.name || device.ip} из топологии?`)) {
            return;
        }
        
        fetch(`/api/topology/device/${device.id}`, {
            method: 'DELETE'
        })
            .then(response => response.json())
            .then(data => {
                console.log('Результат удаления:', data);
                
                if (data.success) {
                    showNotification(`Устройство ${device.name || device.ip} удалено из топологии`, 'success');
                    
                    // Перезагружаем данные топологии
                    loadTopologyData();
                } else {
                    showNotification(`Ошибка при удалении устройства: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Ошибка при удалении устройства:', error);
                showNotification(`Ошибка при удалении устройства: ${error.message}`, 'error');
            });
    }
    
    /**
     * Сохраняет топологию
     */
    function saveTopology() {
        // Получаем данные топологии из визуализатора
        const topologyData = visualizer.getData();
        
        fetch('/api/topology/network', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(topologyData)
        })
            .then(response => response.json())
            .then(data => {
                console.log('Результат сохранения:', data);
                
                if (data.success) {
                    showNotification('Топология сети успешно сохранена', 'success');
                } else {
                    showNotification(`Ошибка при сохранении топологии: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Ошибка при сохранении топологии:', error);
                showNotification(`Ошибка при сохранении топологии: ${error.message}`, 'error');
            });
    }
    
    /**
     * Сканирует сеть
     */
    function startNetworkScan() {
        const rangeValue = scanRange.value.trim();
        if (!rangeValue) {
            alert('Укажите диапазон IP адресов для сканирования');
            return;
        }
        
        // Скрываем кнопки и показываем прогресс
        startScanBtn.style.display = 'none';
        cancelScanBtn.style.display = 'none';
        addDevicesBtn.style.display = 'none';
        scanProgress.style.display = 'block';
        scanResults.style.display = 'none';
        
        // Сбрасываем прогресс
        progressBar.style.width = '0%';
        progressText.textContent = 'Сканирование: 0%';
        
        // Параметры сканирования
        const scanParams = {
            range: rangeValue,
            options: {
                scan_ports: scanPorts.checked,
                detect_vendors: scanVendors.checked,
                detect_services: scanServices.checked
            }
        };
        
        // Отправляем запрос на сканирование
        fetch('/api/topology/scan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(scanParams)
        })
            .then(response => response.json())
            .then(data => {
                console.log('Запущено сканирование:', data);
                
                if (data.job_id) {
                    scanJobId = data.job_id;
                    
                    // Запускаем проверку статуса сканирования
                    checkScanStatus();
                } else {
                    showNotification(`Ошибка при запуске сканирования: ${data.message}`, 'error');
                    resetScanForm();
                }
            })
            .catch(error => {
                console.error('Ошибка при запуске сканирования:', error);
                showNotification(`Ошибка при запуске сканирования: ${error.message}`, 'error');
                resetScanForm();
            });
    }
    
    /**
     * Проверяет статус сканирования
     */
    function checkScanStatus() {
        if (!scanJobId) return;
        
        fetch(`/api/topology/scan/${scanJobId}`)
            .then(response => response.json())
            .then(data => {
                console.log('Статус сканирования:', data);
                
                // Обновляем прогресс
                const percent = data.progress || 0;
                progressBar.style.width = `${percent}%`;
                progressText.textContent = `Сканирование: ${percent}%`;
                
                if (data.status === 'completed') {
                    // Сканирование завершено
                    setTimeout(() => {
                        progressText.textContent = 'Сканирование завершено';
                        
                        // Показываем результаты
                        showScanResults(data.devices || []);
                    }, 500);
                } else if (data.status === 'failed') {
                    // Ошибка сканирования
                    progressText.textContent = `Ошибка: ${data.message || 'Неизвестная ошибка'}`;
                    
                    // Возвращаем кнопки
                    setTimeout(resetScanForm, 1000);
                    
                    // Показываем уведомление об ошибке
                    showNotification(`Ошибка сканирования: ${data.message || 'Неизвестная ошибка'}`, 'error');
                } else {
                    // Сканирование продолжается, проверяем снова через 1 секунду
                    setTimeout(checkScanStatus, 1000);
                }
            })
            .catch(error => {
                console.error('Ошибка при проверке статуса сканирования:', error);
                
                // Возвращаем кнопки
                setTimeout(resetScanForm, 1000);
                
                // Показываем уведомление об ошибке
                showNotification(`Ошибка при проверке статуса сканирования: ${error.message}`, 'error');
            });
    }
    
    /**
     * Показывает результаты сканирования
     */
    function showScanResults(devices) {
        // Обновляем счетчик
        scanFoundCount.textContent = devices.length;
        
        // Заполняем список устройств
        let listHtml = '';
        
        devices.forEach(device => {
            listHtml += `
                <div class="scan-device-item">
                    <input type="checkbox" id="scan-device-${device.id}" data-id="${device.id}" checked>
                    <label for="scan-device-${device.id}">
                        ${device.name || device.ip} (${device.ip})
                    </label>
                </div>
            `;
        });
        
        scanDevicesList.innerHTML = listHtml;
        
        // Показываем результаты и кнопку добавления
        scanResults.style.display = 'block';
        addDevicesBtn.style.display = 'block';
        cancelScanBtn.style.display = 'block';
    }
    
    /**
     * Добавляет выбранные устройства в топологию
     */
    function addScannedDevices() {
        // Получаем выбранные устройства
        const selectedDevices = [];
        scanDevicesList.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
            selectedDevices.push(checkbox.getAttribute('data-id'));
        });
        
        if (selectedDevices.length === 0) {
            alert('Выберите устройства для добавления');
            return;
        }
        
        // Отправляем запрос на добавление устройств
        fetch('/api/topology/devices/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                devices: selectedDevices,
                job_id: scanJobId
            })
        })
            .then(response => response.json())
            .then(data => {
                console.log('Результат добавления устройств:', data);
                
                if (data.success) {
                    // Закрываем модальное окно
                    scanNetworkModal.classList.remove('show');
                    
                    // Сбрасываем форму
                    resetScanForm();
                    
                    // Перезагружаем данные топологии
                    loadTopologyData();
                    
                    // Показываем уведомление
                    showNotification(`Добавлено устройств: ${data.added_count}`, 'success');
                } else {
                    showNotification(`Ошибка при добавлении устройств: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Ошибка при добавлении устройств:', error);
                showNotification(`Ошибка при добавлении устройств: ${error.message}`, 'error');
            });
    }
    
    /**
     * Сбрасывает форму сканирования
     */
    function resetScanForm() {
        startScanBtn.style.display = 'block';
        cancelScanBtn.style.display = 'block';
        addDevicesBtn.style.display = 'none';
        scanProgress.style.display = 'none';
        scanResults.style.display = 'none';
        scanJobId = null;
    }
    
    // Обработчики событий для кнопок в панели деталей устройства
    closeDeviceDetails.addEventListener('click', () => {
        deviceDetails.style.display = 'none';
        
        // Отменяем выбор узла в визуализаторе
        if (visualizer && selectedDevice) {
            visualizer.deselectNode();
        }
    });
    
    pingDeviceBtn.addEventListener('click', () => {
        if (selectedDevice) {
            pingDevice(selectedDevice);
        }
    });
    
    scanDeviceBtn.addEventListener('click', () => {
        if (selectedDevice) {
            scanRange.value = selectedDevice.ip;
            scanNetworkModal.classList.add('show');
        }
    });
    
    removeDeviceBtn.addEventListener('click', () => {
        if (selectedDevice) {
            removeDevice(selectedDevice);
        }
    });
    
    // Обработчики для сканирования сети
    scanNetworkBtn.addEventListener('click', () => {
        scanNetworkModal.classList.add('show');
    });
    
    closeScanModal.addEventListener('click', () => {
        scanNetworkModal.classList.remove('show');
        resetScanForm();
    });
    
    cancelScanBtn.addEventListener('click', () => {
        scanNetworkModal.classList.remove('show');
        resetScanForm();
    });
    
    startScanBtn.addEventListener('click', startNetworkScan);
    addDevicesBtn.addEventListener('click', addScannedDevices);
    
    // Обработчик для сохранения топологии
    saveTopologyBtn.addEventListener('click', saveTopology);
    
    // Обработчик для повторной загрузки данных
    document.getElementById('retryLoadBtn').addEventListener('click', loadTopologyData);
    
    // При клике за пределами модального окна, закрываем его
    scanNetworkModal.addEventListener('click', (event) => {
        if (event.target === scanNetworkModal || event.target === scanNetworkModal.querySelector('.modal-backdrop')) {
            scanNetworkModal.classList.remove('show');
            resetScanForm();
        }
    });
});
</script>
{% endblock %}